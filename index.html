<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Difficult Conversations Simulator</title>

    <meta name="description" content="Practice difficult conversations with an AI simulator.">
    <meta name="theme-color" content="#363636"> <!-- Dark theme color -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DiffConvSim">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    <style>
        /* Global Styles & Dark Mode defaults from Bulma */
        html[data-theme="dark"] {
            /* Bulma 1.0 uses CSS variables for theming. This attribute activates its dark mode. */
            /* You can further customize dark theme variables here if needed */
        }
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden; /* Prevent horizontal scroll during transitions */
            padding-top: 3.25rem; /* Height of Bulma navbar */
            min-height: 100vh;
        }

        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
            min-height: calc(100vh - 3.25rem); /* Full height minus navbar */
            box-sizing: border-box;
        }
        .page.is-active {
            display: flex; /* Using flex for centering content */
            flex-direction: column;
            opacity: 1;
        }

        /* Splash Screen */
        #splash-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: hsl(0, 0%, 7%); /* Very dark for splash */
            color: hsl(0, 0%, 96%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            padding-top: 0; /* Override body padding-top for full screen */
            min-height: 100vh;
        }
        #splash-screen .title {
            font-size: 2.5rem;
            color: hsl(0, 0%, 96%);
            animation: fadeInScaleUp 1.5s ease-out forwards;
        }
        @keyframes fadeInScaleUp {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Navbar */
        .navbar.is-fixed-top {
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .navbar-brand .navbar-item img {
            max-height: 2.5rem; /* Adjust logo size */
        }
        .app-title-navbar {
            font-weight: bold;
        }

        /* Home Page Specifics */
        #home-page .section {
            width: 100%;
            max-width: 700px; /* Content max width */
            margin: 0 auto; /* Center content */
            padding: 1.5rem;
        }
         #home-page .button-container {
            margin-top: 1.5rem;
            text-align: center;
        }

        /* API Key Modal */
        .modal-card-body .content ul {
            margin-left: 1em; /* Indent instructions list */
        }
        .api-key-instructions {
            font-size: 0.9rem;
        }
        #geminiApiKeyStatusModal { margin-top: 10px; }


        /* Chat Page Specifics */
        #chat-page-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 3.25rem); /* Full height minus navbar */
            width: 100%;
            max-width: 800px; /* Chat content max width */
            margin: 0 auto; /* Center content */
        }
        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid hsl(0, 0%, 29%); /* Darker border */
            border-radius: 6px;
            margin-bottom: 1rem;
            background-color: hsl(0, 0%, 14%); /* Slightly lighter than body for contrast */
        }
        .message-container { margin-bottom: 10px; display: flex; animation: slideInUp 0.3s ease-out; }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 15px; max-width: 80%; word-wrap: break-word; line-height: 1.4; font-size: 0.95rem; }
        .message-container.user { justify-content: flex-end; }
        .message-container.user .message-bubble { background-color: hsl(204, 71%, 53%); color: white; border-bottom-right-radius: 5px; }
        .message-container.assistant .message-bubble { background-color: hsl(0, 0%, 29%); color: hsl(0, 0%, 96%); border-bottom-left-radius: 5px; }
        .message-container.error .message-bubble { background-color: hsl(348, 86%, 61%); color: white; }

        #input-area { display: flex; padding: 0 1rem 1rem 1rem; }
        #user-input-chat { flex-grow: 1; margin-right: 0.5rem; }
        #send-button-chat.is-loading {
            pointer-events: none;
        }

        /* Status & Error Log */
        #mainStatusFooter {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            background-color: hsl(0, 0%, 21%);
            text-align: center;
        }
        #errorLogContainer {
            margin: 1rem;
            font-size: 0.8em;
        }
        #errorLog {
            max-height: 100px;
            overflow-y: auto;
            background-color: hsl(0, 0%, 18%);
            border: 1px solid hsl(0, 0%, 29%);
            padding: 0.5rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .log-entry { margin-bottom: 5px; color: hsl(348, 100%, 71%); }
        .log-entry pre { color: hsl(348, 100%, 81%); white-space: pre-wrap; word-break: break-all;}

        /* Helper for hidden */
        .is-hidden-completely { display: none !important; }
        .is-visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen" class="page is-active">
        <h1 class="title">Difficult Conversations Simulator</h1>
    </div>

    <!-- Navigation Bar (Common for Home and Chat) -->
    <nav id="app-navbar" class="navbar is-fixed-top is-dark" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <!-- Placeholder for a logo if you have one -->
                    <!-- <img src="logo.svg" width="28" height="28" alt="Logo"> -->
                    <span class="icon is-medium mr-2"><i class="fas fa-comments"></i></span>
                    <span class="app-title-navbar">DiffConvSim</span>
                </a>
                 <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>
            <div id="navbarMenu" class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item" id="nav-home-button">Setup Conversation</a>
                    <a class="navbar-item is-hidden-completely" id="nav-chat-button">Chat Simulator</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="home-page" class="page">
        <section class="section">
            <div class="container">
                <h2 class="title is-4 has-text-centered">Setup Your Conversation Scenario</h2>
                <p class="subtitle is-6 has-text-centered mb-5">Describe the situation to prepare the AI for the simulation.</p>

                <div class="field">
                    <label class="label" for="conflict-details">Describe the Conflict/Difficult Conversation:</label>
                    <div class="control">
                        <textarea class="textarea" id="conflict-details" placeholder="e.g., I need to talk to my team member about their declining performance..." rows="4"></textarea>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="llm-character-role">Who should the AI pretend to be?</label>
                    <div class="control">
                        <input class="input" type="text" id="llm-character-role" placeholder="e.g., My underperforming team member, John">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="most-desired-sol">What is your MOST desired outcome?</label>
                    <div class="control">
                        <input class="input" type="text" id="most-desired-sol" placeholder="e.g., John acknowledges the issues and commits to an improvement plan.">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="least-desired-sol">What is your LEAST desired outcome?</label>
                    <div class="control">
                        <input class="input" type="text" id="least-desired-sol" placeholder="e.g., John gets defensive, denies any problem, and our relationship sours.">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="compromised-sol">What's a potential COMPROMISED solution you might consider?</label>
                    <div class="control">
                        <input class="input" type="text" id="compromised-sol" placeholder="e.g., We agree on smaller, initial steps for improvement with a follow-up review.">
                    </div>
                </div>

                <div class="button-container">
                    <button class="button is-primary is-medium" id="proceed-to-chat-button">Proceed to Simulation</button>
                </div>
                 <div class="has-text-centered mt-4">
                    <button class="button is-small" id="api-key-button-home">API Key Setup</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Chat Page -->
    <div id="chat-page" class="page">
        <div id="chat-page-content" class="container">
            <div id="chat-box">
                <!-- Messages will be appended here -->
            </div>
            <div id="input-area" class="field has-addons">
                <div class="control is-expanded">
                    <input class="input" type="text" id="user-input-chat" placeholder="Type your message..." disabled>
                </div>
                <div class="control">
                    <button class="button is-info" id="send-button-chat" disabled>
                        <span class="icon"><i class="fas fa-paper-plane"></i></span>
                        <span>Send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Gemini API Key Setup</p>
                <button class="delete" aria-label="close" id="close-api-modal-button"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label" for="geminiApiKeyInputModal">Gemini API Key:</label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="geminiApiKeyInputModal" placeholder="Paste your API Key here">
                        <span class="icon is-small is-left"><i class="fas fa-key"></i></span>
                    </div>
                </div>
                <div class="content api-key-instructions">
                    <p><strong>How to get a Gemini API Key:</strong></p>
                    <ul>
                        <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</li>
                        <li>Sign in with your Google account.</li>
                        <li>Click on "Get API key" or "Create API key in new project".</li>
                        <li>Copy the generated API key and paste it above.</li>
                        <li>Make sure the Gemini API is enabled for your project in Google Cloud Console if you created a new project.</li>
                    </ul>
                </div>
                <div id="geminiApiKeyStatusModal" class="message is-small is-hidden-completely">
                    <div class="message-body"></div>
                </div>
            </section>
            <footer class="modal-card-foot is-justify-content-flex-end">
                <button class="button is-success" id="saveGeminiApiKeyButtonModal">Save and Test Key</button>
                <button class="button" id="cancel-api-modal-button">Cancel</button>
                <button class="button is-danger is-outlined ml-auto" id="clearGeminiApiKeyButtonModal">Clear Stored Key</button>
            </footer>
        </div>
    </div>

    <!-- Footer for Status Messages (optional, can be removed or integrated) -->
    <footer id="mainStatusFooter" class="is-hidden-completely">Current Status...</footer>
    <div id="errorLogContainer" class="is-hidden-completely">
        <p class="has-text-weight-bold">Error Log:</p>
        <div id="errorLog"></div>
    </div>


    <script type="module">
        // --- PWA Setup ---
        const PWA_SETUP = {
            SW_VERSION_REFERENCE: 'v1.0.4', // Increment if sw.js or index.html changes
            APP_NAME: "Difficult Conversations Simulator",
            SHORT_NAME: "DiffConvSim",
            DESCRIPTION: "Practice difficult conversations with an AI simulator.",
            THEME_COLOR: "#363636",
            BACKGROUND_COLOR: "#1a1a1a", // Dark background
            START_URL: "./index.html",

            createSvgDataUrl: function(svgString) {
                return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgString)))}`;
            },
            generateIcons: function() {
                const iconSvgContent = `<path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>`; // Simple chat bubble
                const iconSvgTemplate = (size, bgColor = this.THEME_COLOR, fgColor = "white") => `
                    <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24">
                        <rect width="24" height="24" fill="${bgColor}"/>
                        <g style="color:${fgColor};">${iconSvgContent}</g>
                    </svg>`.trim();
                this.appleTouchIconUrl = this.createSvgDataUrl(iconSvgTemplate(180));
                this.manifestIconUrl192 = this.createSvgDataUrl(iconSvgTemplate(192));
                this.manifestIconUrl512 = this.createSvgDataUrl(iconSvgTemplate(512));
            },
            setupManifest: function() {
                const manifest = {
                    name: this.APP_NAME, short_name: this.SHORT_NAME, description: this.DESCRIPTION,
                    start_url: this.START_URL, display: "standalone", background_color: this.BACKGROUND_COLOR,
                    theme_color: this.THEME_COLOR,
                    icons: [
                        { src: this.manifestIconUrl192, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
                        { src: this.manifestIconUrl512, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
                    ]
                };
                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestUrl = URL.createObjectURL(manifestBlob);
                const linkManifest = document.createElement('link');
                linkManifest.rel = 'manifest'; linkManifest.href = manifestUrl;
                document.head.appendChild(linkManifest);
            },
            setupAppleTouchIcon: function() {
                const linkAppleIcon = document.createElement('link');
                linkAppleIcon.rel = 'apple-touch-icon'; linkAppleIcon.href = this.appleTouchIconUrl;
                document.head.appendChild(linkAppleIcon);
            },
            registerServiceWorker: function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('Service Worker registered:', reg.scope))
                        .catch(err => console.error('Service Worker registration failed:', err));
                }
            },
            init: function() {
                try {
                    this.generateIcons(); this.setupManifest(); this.setupAppleTouchIcon(); this.registerServiceWorker();
                } catch (e) { console.error("PWA Setup Error:", e); }
            }
        };
        PWA_SETUP.init();

        // DOM Elements
        const pages = {
            splash: document.getElementById('splash-screen'),
            home: document.getElementById('home-page'),
            chat: document.getElementById('chat-page'),
        };
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyButtonHome = document.getElementById('api-key-button-home');
        const saveGeminiApiKeyButtonModal = document.getElementById('saveGeminiApiKeyButtonModal');
        const clearGeminiApiKeyButtonModal = document.getElementById('clearGeminiApiKeyButtonModal');
        const geminiApiKeyInputModal = document.getElementById('geminiApiKeyInputModal');
        const geminiApiKeyStatusModalDiv = document.getElementById('geminiApiKeyStatusModal');
        const proceedToChatButton = document.getElementById('proceed-to-chat-button');

        const conflictDetailsInput = document.getElementById('conflict-details');
        const llmCharacterRoleInput = document.getElementById('llm-character-role');
        const mostDesiredSolInput = document.getElementById('most-desired-sol');
        const leastDesiredSolInput = document.getElementById('least-desired-sol');
        const compromisedSolInput = document.getElementById('compromised-sol');

        const chatBox = document.getElementById('chat-box');
        const userInputChat = document.getElementById('user-input-chat');
        const sendButtonChat = document.getElementById('send-button-chat');
        
        const errorLogDiv = document.getElementById('errorLog');
        const navHomeButton = document.getElementById('nav-home-button');
        const navChatButton = document.getElementById('nav-chat-button');
        const navbarBurger = document.querySelector('.navbar-burger');
        const navbarMenu = document.getElementById('navbarMenu');


        // --- State Variables ---
        let currentPageId = 'splash';
        let geminiApiKey = null;
        let isGeminiKeyValid = false; // More explicit state for key validity
        let geminiApiHistory = []; // For Gemini API: [{role: "user"|"model", parts: [{text: "..."}]}]
        let currentSystemPrompt = "";

        // Gemini Config
        const GEMINI_API_KEY_STORAGE_KEY = 'geminiApiKey_diff_conv_sim';
        // Use a model that supports systemInstruction if possible for cleaner prompts
        const GEMINI_MODEL_NAME = "gemini-1.5-flash-latest"; 
        const GEMINI_API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';

        // --- Utility Functions ---
        function logError(errorSource, error) {
            console.error(errorSource, error);
            const errorLogContainer = document.getElementById('errorLogContainer');
            errorLogContainer.classList.remove('is-hidden-completely');
            const timestamp = new Date().toLocaleTimeString();
            const errorEntry = document.createElement('div');
            errorEntry.classList.add('log-entry');
            const errorMessageText = (error instanceof Error) ? error.message : String(error);
            errorEntry.textContent = `[${timestamp}] ${errorSource}: ${errorMessageText}`;
            if (error instanceof Error && error.stack) {
                const stackTrace = document.createElement('pre');
                stackTrace.textContent = error.stack;
                errorEntry.appendChild(stackTrace);
            }
            errorLogDiv.appendChild(errorEntry);
            errorLogDiv.scrollTop = errorLogDiv.scrollHeight;
        }

        function showStatusInModal(message, type = 'info') { // type: 'info', 'success', 'warning', 'danger'
            geminiApiKeyStatusModalDiv.classList.remove('is-hidden-completely', 'is-info', 'is-success', 'is-warning', 'is-danger');
            geminiApiKeyStatusModalDiv.classList.add(`is-${type}`);
            geminiApiKeyStatusModalDiv.querySelector('.message-body').textContent = message;
        }
        function hideStatusInModal() {
            geminiApiKeyStatusModalDiv.classList.add('is-hidden-completely');
        }

        // --- Navigation ---
        function navigateTo(pageId) {
            if (pages[currentPageId]) pages[currentPageId].classList.remove('is-active');
            if (pages[pageId]) {
                pages[pageId].classList.add('is-active');
                currentPageId = pageId;
                document.body.scrollTop = 0; // Scroll to top
                document.documentElement.scrollTop = 0;

                // Update navbar active state
                navHomeButton.classList.toggle('is-active', pageId === 'home');
                navChatButton.classList.toggle('is-active', pageId === 'chat');
                navChatButton.classList.toggle('is-hidden-completely', pageId !== 'chat' && !geminiApiHistory.length); // Show chat nav only if on chat or history exists
            } else {
                console.error("Page not found:", pageId);
            }
        }
        navHomeButton.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home'); });
        navChatButton.addEventListener('click', (e) => { e.preventDefault(); navigateTo('chat'); });
        navbarBurger.addEventListener('click', () => {
            navbarBurger.classList.toggle('is-active');
            navbarMenu.classList.toggle('is-active');
        });


        // --- API Key Management ---
        function loadGeminiApiKeyFromStorage() {
            const storedKey = localStorage.getItem(GEMINI_API_KEY_STORAGE_KEY);
            if (storedKey) {
                geminiApiKey = storedKey;
                geminiApiKeyInputModal.value = storedKey; // Pre-fill in modal
                apiKeyButtonHome.classList.remove('is-danger');
                apiKeyButtonHome.classList.add('is-success');
                apiKeyButtonHome.innerHTML = '<span class="icon"><i class="fas fa-key"></i></span><span>API Key Set</span>';
                isGeminiKeyValid = true; // Assume valid if stored, test will confirm if user tries to save again
                return true;
            } else {
                apiKeyButtonHome.classList.add('is-danger');
                apiKeyButtonHome.classList.remove('is-success');
                apiKeyButtonHome.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span><span>Set API Key</span>';
                isGeminiKeyValid = false;
                return false;
            }
        }

        async function testAndSaveGeminiApiKey() {
            const key = geminiApiKeyInputModal.value.trim();
            if (!key) {
                showStatusInModal('API Key cannot be empty.', 'warning');
                return false;
            }

            showStatusInModal('Validating API Key...', 'info');
            saveGeminiApiKeyButtonModal.classList.add('is-loading');

            try {
                const testApiUrl = `${GEMINI_API_BASE_URL}${GEMINI_MODEL_NAME}:generateContent?key=${key}`;
                const response = await fetch(testApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "contents": [{"parts": [{"text": "Hi"}]}] })
                });

                if (response.ok) {
                    localStorage.setItem(GEMINI_API_KEY_STORAGE_KEY, key);
                    geminiApiKey = key;
                    isGeminiKeyValid = true;
                    showStatusInModal('API Key is valid and saved successfully!', 'success');
                    loadGeminiApiKeyFromStorage(); // Update home button
                    setTimeout(() => closeApiKeyModal(), 1500); // Auto-close on success
                    return true;
                } else {
                    const errorData = await response.json();
                    const errorMsg = `API Key validation failed: ${errorData.error?.message || response.statusText}. Please check your key.`;
                    showStatusInModal(errorMsg, 'danger');
                    logError("Gemini Key Validation", errorMsg);
                    isGeminiKeyValid = false;
                    return false;
                }
            } catch (error) {
                const errorMsg = `Error during API key validation: ${error.message}`;
                showStatusInModal(errorMsg, 'danger');
                logError("Gemini Key Validation Error", error);
                isGeminiKeyValid = false;
                return false;
            } finally {
                saveGeminiApiKeyButtonModal.classList.remove('is-loading');
            }
        }

        function clearGeminiApiKey() {
            localStorage.removeItem(GEMINI_API_KEY_STORAGE_KEY);
            geminiApiKey = null;
            isGeminiKeyValid = false;
            geminiApiKeyInputModal.value = '';
            showStatusInModal('Stored API Key cleared.', 'info');
            loadGeminiApiKeyFromStorage(); // Update home button
        }

        // Modal Open/Close
        function openApiKeyModal() { apiKeyModal.classList.add('is-active'); hideStatusInModal(); }
        function closeApiKeyModal() { apiKeyModal.classList.remove('is-active'); }
        apiKeyButtonHome.addEventListener('click', openApiKeyModal);
        saveGeminiApiKeyButtonModal.addEventListener('click', testAndSaveGeminiApiKey);
        clearGeminiApiKeyButtonModal.addEventListener('click', clearGeminiApiKey);
        document.getElementById('close-api-modal-button').addEventListener('click', closeApiKeyModal);
        document.getElementById('cancel-api-modal-button').addEventListener('click', closeApiKeyModal);
        apiKeyModal.querySelector('.modal-background').addEventListener('click', closeApiKeyModal);


        // --- Chat Logic ---
        function constructSystemPrompt(details, role, mostSol, leastSol, compSol) {
            return `You are acting as '${role}' in a simulated difficult conversation. The user is practicing how to navigate this situation.
The context of the difficult conversation is:
${details}

The user's goals are:
- Most desired outcome: ${mostSol}
- Least desired outcome: ${leastSol}
- A potential compromise the user is considering: ${compSol}

Your task is to:
1. First, offer the user two distinct strategic approaches (Option A and Option B) they could take to initiate or handle this conversation with you (as '${role}'), considering their stated goals and the conflict. Briefly explain each option. Use Markdown for bolding option labels like **Option A:**.
2. Wait for the user to choose an option or to start the conversation in their own way.
3. Once the user has chosen an option or started talking, fully embody the character of '${role}'. Respond naturally and realistically based on the persona and the situation described.
4. Help the user practice by reacting to their statements. Do not lead the entire conversation; wait for the user's input at each step of the role-play.
Your persona as '${role}' should be consistent throughout the simulation.
Begin by presenting Option A and Option B.`;
        }

        function addMessageToChatUI(text, role, isError = false) {
            const container = document.createElement("div");
            container.classList.add("message-container", role);
            if (isError) container.classList.add("error");

            const bubble = document.createElement("div");
            bubble.classList.add("message-bubble");
            
            // Basic Markdown for bold and newlines
            let content = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\n/g, '<br>');
            bubble.innerHTML = content;

            container.appendChild(bubble);
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function updateLastBotMessageInUI(content) {
            const lastBotMessageContainer = chatBox.querySelector('.message-container.assistant:last-child .message-bubble');
            if (lastBotMessageContainer) {
                let formattedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedContent = formattedContent.replace(/\n/g, '<br>');
                lastBotMessageContainer.innerHTML = formattedContent;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        async function sendInitialBotMessage() {
            if (!isGeminiKeyValid) {
                addMessageToChatUI("API Key is not set or invalid. Please set it up on the home page.", "assistant", true);
                logError("Chat Init", "Gemini API key not valid.");
                sendButtonChat.disabled = true;
                userInputChat.disabled = true;
                return;
            }

            sendButtonChat.disabled = true;
            sendButtonChat.classList.add('is-loading');
            userInputChat.disabled = true;
            userInputChat.placeholder = "AI is preparing initial options...";
            chatBox.innerHTML = ''; // Clear chat for new session
            geminiApiHistory = []; // Reset history for new session

            addMessageToChatUI("▍", "assistant"); // Typing indicator

            let accumulatedMessage = "";
            let animationFrameId;
            let cursorVisible = true;
            const typingIndicator = () => { // This is a simple UI typing indicator, not tied to actual streaming
                if (!sendButtonChat.classList.contains('is-loading')) { // Check if generation is finished
                    updateLastBotMessageInUI(accumulatedMessage);
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    return;
                }
                updateLastBotMessageInUI(accumulatedMessage + (cursorVisible ? "▍" : ""));
                cursorVisible = !cursorVisible;
                animationFrameId = requestAnimationFrame(typingIndicator);
            };
            animationFrameId = requestAnimationFrame(typingIndicator);

            try {
                // The system prompt is now passed directly in the request for Gemini
                const requestBody = {
                    contents: [{ role: "user", parts: [{ text: "Let's begin the simulation. Please provide the initial options as per your instructions." }] }],
                    systemInstruction: { parts: [{ text: currentSystemPrompt }] },
                    generationConfig: { temperature: 0.7, topP: 0.95, maxOutputTokens: 2048 }
                };
                // We don't add "Let's begin..." to geminiApiHistory as it's an instruction to the *system*, not part of the role-play.
                // The role-play history starts *after* the initial options.

                const response = await fetch(`${GEMINI_API_BASE_URL}${GEMINI_MODEL_NAME}:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                sendButtonChat.classList.remove('is-loading'); // Stop loading indicator after fetch
                if (animationFrameId) cancelAnimationFrame(animationFrameId); // Stop typing animation

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error (Initial): ${errorData.error?.message || response.statusText}`);
                }
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    accumulatedMessage = data.candidates[0].content.parts[0].text;
                    updateLastBotMessageInUI(accumulatedMessage);
                    geminiApiHistory.push({ role: "model", parts: [{ text: accumulatedMessage }] });
                    userInputChat.disabled = false;
                    sendButtonChat.disabled = false;
                    userInputChat.placeholder = "Type your response...";
                    userInputChat.focus();
                } else {
                    throw new Error("Invalid response structure from Gemini (Initial).");
                }
            } catch (err) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                sendButtonChat.classList.remove('is-loading');
                logError("Gemini InitialBotMsg", err);
                updateLastBotMessageInUI(`Error getting initial advice: ${err.message}`);
                addMessageToChatUI(`Error: ${err.message}`, "assistant", true); // Add distinct error message
                userInputChat.disabled = true;
                sendButtonChat.disabled = true;
            }
        }

        async function handleSendMessageToGemini() {
            const inputText = userInputChat.value.trim();
            if (inputText.length === 0 || !isGeminiKeyValid || sendButtonChat.classList.contains('is-loading')) return;

            addMessageToChatUI(inputText, "user");
            geminiApiHistory.push({ role: "user", parts: [{ text: inputText }] });
            userInputChat.value = "";
            sendButtonChat.disabled = true;
            sendButtonChat.classList.add('is-loading');
            userInputChat.disabled = true;
            userInputChat.placeholder = "AI is thinking...";

            addMessageToChatUI("▍", "assistant"); // Typing indicator

            let accumulatedMessage = "";
            let animationFrameId;
            let cursorVisible = true;
            const typingIndicator = () => {
                if (!sendButtonChat.classList.contains('is-loading')) {
                    updateLastBotMessageInUI(accumulatedMessage);
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    return;
                }
                updateLastBotMessageInUI(accumulatedMessage + (cursorVisible ? "▍" : ""));
                cursorVisible = !cursorVisible;
                animationFrameId = requestAnimationFrame(typingIndicator);
            };
            animationFrameId = requestAnimationFrame(typingIndicator);

            try {
                const requestBody = {
                    contents: geminiApiHistory, // Send full conversational history
                    systemInstruction: { parts: [{ text: currentSystemPrompt }] }, // Re-iterate system context
                    generationConfig: { temperature: 0.7, topP: 0.95, maxOutputTokens: 2048 }
                };

                const response = await fetch(`${GEMINI_API_BASE_URL}${GEMINI_MODEL_NAME}:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                sendButtonChat.classList.remove('is-loading');
                if (animationFrameId) cancelAnimationFrame(animationFrameId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${errorData.error?.message || response.statusText}`);
                }
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    accumulatedMessage = data.candidates[0].content.parts[0].text;
                    updateLastBotMessageInUI(accumulatedMessage);
                    geminiApiHistory.push({ role: "model", parts: [{ text: accumulatedMessage }] });
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    accumulatedMessage = `Blocked by API: ${data.promptFeedback.blockReason}.`;
                    logError("Gemini Response Blocked", accumulatedMessage);
                    updateLastBotMessageInUI(accumulatedMessage);
                    // Don't add to history as a valid model response if blocked
                } else {
                    throw new Error("Invalid response structure from Gemini.");
                }
            } catch (err) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                sendButtonChat.classList.remove('is-loading');
                logError("Gemini SendMessage", err);
                updateLastBotMessageInUI(`Error generating response: ${err.message}`);
                addMessageToChatUI(`Error: ${err.message}`, "assistant", true);
            } finally {
                userInputChat.disabled = false;
                sendButtonChat.disabled = false;
                userInputChat.placeholder = "Type your response...";
                userInputChat.focus();
            }
        }
        sendButtonChat.addEventListener("click", handleSendMessageToGemini);
        userInputChat.addEventListener("keypress", (event) => {
            if (event.key === "Enter" && !sendButtonChat.disabled && !sendButtonChat.classList.contains('is-loading')) {
                event.preventDefault();
                handleSendMessageToGemini();
            }
        });


        // --- Home Page Logic ---
        proceedToChatButton.addEventListener('click', () => {
            const conflictDetails = conflictDetailsInput.value.trim();
            const llmCharacterRole = llmCharacterRoleInput.value.trim();
            const mostDesiredSol = mostDesiredSolInput.value.trim();
            const leastDesiredSol = leastDesiredSolInput.value.trim();
            const compromisedSol = compromisedSolInput.value.trim();

            if (!conflictDetails || !llmCharacterRole || !mostDesiredSol || !leastDesiredSol) {
                alert("Please fill in all required fields: Description, AI Role, Most and Least Desired Outcomes.");
                return;
            }
            if (!isGeminiKeyValid) {
                 openApiKeyModal();
                 showStatusInModal("Please set and validate your Gemini API Key before proceeding.", "warning");
                return;
            }

            currentSystemPrompt = constructSystemPrompt(
                conflictDetails, llmCharacterRole, mostDesiredSol, leastDesiredSol, compromisedSol
            );
            navigateTo('chat');
            sendInitialBotMessage();
        });


        // -- Initial Application Load ---
        functioninitializeApp() {
            PWA_SETUP.init(); // Initialize PWA features

            setTimeout(() => {
                if (pages.splash) pages.splash.classList.remove('is-active');
                navigateTo('home');
                loadGeminiApiKeyFromStorage(); // Check API key status for home button
            }, 2000); // Splash screen duration
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>